name: build

on:
    push:
        branches:
            - main
    workflow_dispatch:

jobs:
    build:
        runs-on: windows-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Prepare output
              shell: pwsh
              run: |
                  if (Test-Path out) { Remove-Item out -Recurse -Force }
                  New-Item -ItemType Directory -Path out\alt-number-input | Out-Null

            - name: Extract Ahk2Exe portable
              shell: pwsh
              run: |
                  Expand-Archive -Path tools\AutoHotkey2ExePortable.zip -DestinationPath tools\ahk2exe -Force

            - name: Find Ahk2Exe.exe
              shell: pwsh
              run: |
                  $exe = Get-ChildItem -Path tools\ahk2exe -Recurse -Filter Ahk2Exe.exe | Select-Object -First 1
                  if (-not $exe) { throw "Ahk2Exe.exe not found." }
                  "AHK2EXE_PATH=$($exe.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding ascii -Append

            - name: Compile
              shell: pwsh
              run: |
                  & "$env:AHK2EXE_PATH" /in "src\AltNum.ahk" /out "out\alt-number-input\AltNum.exe" /icon "assets\altnum_512px.ico"

            - name: Copy runtime files
              shell: pwsh
              run: |
                  Copy-Item "src\settings.txt" "out\alt-number-input\settings.txt" -Force
                  Copy-Item "assets" "out\alt-number-input\assets" -Recurse -Force

            - name: Zip
              shell: pwsh
              run: |
                  if (Test-Path alt-number-input.zip) { Remove-Item alt-number-input.zip -Force }
                  Compress-Archive -Path "out\alt-number-input\*" -DestinationPath "alt-number-input.zip" -Force

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: alt-number-input
                  path: alt-number-input.zip
